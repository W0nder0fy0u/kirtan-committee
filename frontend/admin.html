<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>KIRTAN Committee | Adhyaksh Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 20px;
    }

    h1 {
      text-align: center;
      color: #2c3e50;
    }

    .login, .panel {
      max-width: 1000px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    .login input {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
    }

    button {
      padding: 8px 14px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      background: #2c3e50;
      color: white;
    }

    button.danger { background: #e74c3c; }
    button.secondary { background: #16a085; }

    .member {
      border: 1px solid #ddd;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 6px;
      background: #fafafa;
    }

    label {
      display: block;
      margin-top: 8px;
      font-size: 13px;
    }

    input, select {
      width: 100%;
      padding: 6px;
      margin-top: 4px;
    }

    .top-actions {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      gap: 10px;
      flex-wrap: wrap;
    }

    .month-box {
      background: #eef2f6;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 20px;
    }
  </style>
</head>

<body>

<h1>KIRTAN Committee – Adhyaksh Panel</h1>

<div class="login" id="loginBox">
  <h3>Adhyaksh Login</h3>
  <input type="password" id="password" placeholder="Enter password" />
  <button onclick="login()">Login</button>
</div>

<div class="panel" id="panel" style="display:none;">

  <div class="month-box">
    <label><b>Select Month (₹500 Monthly Contribution)</b></label>
    <input type="month" id="selectedMonth">
  </div>

  <div class="top-actions">
    <button class="secondary" onclick="addMember()">+ Add Member</button>
    <button onclick="saveAll()">Save Monthly Update</button>
  </div>

  <div id="members"></div>
</div>

<script>
const API = "https://kirtan-committee-backend.vercel.app";


let committeeData = null;
let PASSWORD = "";

// auto-select current month
document.addEventListener("DOMContentLoaded", () => {
  const now = new Date();
  document.getElementById("selectedMonth").value =
    now.toISOString().slice(0,7);
});

function login() {
  PASSWORD = document.getElementById("password").value;

  fetch(API + "/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ password: PASSWORD })
  })
  .then(res => {
    if (!res.ok) throw new Error();
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("panel").style.display = "block";
    loadData();
  })
  .catch(() => alert("Wrong password"));
}

function loadData() {
  fetch(API + "/data")
    .then(res => res.json())
    .then(data => {
      committeeData = data;
      committeeData.members.forEach(m => {
        if (!m.monthlyPayments) m.monthlyPayments = {};
        if (!m.loan) {
          m.loan = { taken:false, amount:0, interest:0, dueDate:null, outstanding:0 };
        }
      });
      renderMembers();
    });
}

document.getElementById("selectedMonth").addEventListener("change", renderMembers);

function renderMembers() {
  const container = document.getElementById("members");
  const month = document.getElementById("selectedMonth").value;
  container.innerHTML = "";

  if (!month) {
    container.innerHTML = "<p><b>Please select a month.</b></p>";
    return;
  }

  committeeData.members.forEach((m, i) => {
    if (m.monthlyPayments[month] === undefined) {
      m.monthlyPayments[month] = false;
    }

    const div = document.createElement("div");
    div.className = "member";

    div.innerHTML = `
      <h3>${m.name || "New Member"}</h3>

      <label>Member Name</label>
      <input value="${m.name}" onchange="committeeData.members[${i}].name=this.value">

      <label>Role</label>
      <select onchange="committeeData.members[${i}].role=this.value">
        <option ${m.role==="Member"?"selected":""}>Member</option>
        <option ${m.role==="Adhyaksh"?"selected":""}>Adhyaksh</option>
      </select>

      <label>₹500 Paid for ${month}</label>
      <input type="checkbox"
        ${m.monthlyPayments[month] ? "checked" : ""}
        onchange="committeeData.members[${i}].monthlyPayments['${month}']=this.checked">

      <hr>

      <label>Loan Taken</label>
      <select onchange="committeeData.members[${i}].loan.taken=(this.value==='true')">
        <option value="false" ${!m.loan.taken?"selected":""}>No</option>
        <option value="true" ${m.loan.taken?"selected":""}>Yes</option>
      </select>

      <label>Loan Amount</label>
      <input type="number" value="${m.loan.amount}"
        onchange="committeeData.members[${i}].loan.amount=Number(this.value)">

      <label>Interest (%)</label>
      <input type="number" value="${m.loan.interest}"
        onchange="committeeData.members[${i}].loan.interest=Number(this.value)">

      <label>Loan Due Date</label>
      <input type="date" value="${m.loan.dueDate || ""}"
        onchange="committeeData.members[${i}].loan.dueDate=this.value">

      <label>Outstanding Amount</label>
      <input type="number" value="${m.loan.outstanding}"
        onchange="committeeData.members[${i}].loan.outstanding=Number(this.value)">

      <br><br>
      <button class="danger" onclick="deleteMember(${i})">Delete Member</button>
    `;

    container.appendChild(div);
  });
}

function addMember() {
  committeeData.members.push({
    id: Date.now(),
    name: "",
    role: "Member",
    monthlyPayments: {},
    loan: {
      taken: false,
      amount: 0,
      interest: 0,
      dueDate: null,
      outstanding: 0
    }
  });
  renderMembers();
}

function deleteMember(index) {
  if (!confirm("Delete this member?")) return;
  committeeData.members.splice(index, 1);
  renderMembers();
}

function saveAll() {
  fetch(API + "/update", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      password: PASSWORD,
      data: committeeData
    })
  })
  .then(res => {
    if (!res.ok) throw new Error();
    alert("Monthly update saved successfully");
  })
  .catch(() => alert("Save failed"));
}
</script>

</body>
</html>
